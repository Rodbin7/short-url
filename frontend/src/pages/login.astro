---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Iniciar Sesión">
	<main class="container mx-auto px-4 pt-24 pb-12">
		<div class="max-w-md mx-auto">
			<h1 class="text-4xl font-bold text-center mb-2 text-white">Bienvenido de Nuevo</h1>
            <p class="text-center text-slate-400 mb-8">Inicia sesión para acortar y gestionar tus enlaces.</p>

			<form id="login-form" class="w-full bg-slate-800/50 border border-white/10 p-8 rounded-xl shadow-lg">
				<div class="mb-4">
					<label for="email" class="block text-slate-300 mb-2">Email</label>
					<input type="email" id="email" name="email" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" required />
				</div>
				<div class="mb-6">
					<label for="password" class="block text-slate-300 mb-2">Contraseña</label>
					<input type="password" id="password" name="password" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
				</div>
				<button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Entrar</button>
			</form>

			<div id="error-message" class="max-w-md mx-auto mt-4 text-center text-red-400 hidden"></div>
			<p class="text-center text-slate-400 mt-6">¿No tienes una cuenta? <a href="/register" class="text-blue-400 hover:underline font-semibold">Regístrate aquí</a></p>
		</div>
	</main>

	<script>
        function setupLoginPage() {
            // Si el usuario ya está logueado, redirigir a la home
			const token = localStorage.getItem('token');
			if (token) {
				window.location.href = '/';
				return;
			}

            const loginForm = document.getElementById('login-form');
            if (!loginForm) return;

			loginForm.addEventListener('submit', async (e) => {
				e.preventDefault();

				const form = e.target as HTMLFormElement;
				const email = (form.elements.namedItem('email') as HTMLInputElement).value;
				const password = (form.elements.namedItem('password') as HTMLInputElement).value;
				// const errorDiv = document.getElementById('error-message'); // Ya no se usa

				// errorDiv.textContent = ''; // Ya no se usa

				try {
					const response = await fetch(`${import.meta.env.PUBLIC_API_URL}/api/auth/login`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ email, password }),
					});

					const data = await response.json();

					if (!response.ok) {
						throw new Error(data.msg || 'Error al iniciar sesión');
					}

					localStorage.setItem('token', data.token);
					window.location.href = '/'; // Redirigir a la página principal
					window.showToast('¡Inicio de sesión exitoso!', 'success');

				} catch (error) {
					// errorDiv.textContent = error.message; // Ya no se usa
					window.showToast(`Error: ${error.message}`, 'error');
				}
			});
        }

        // Ejecutar en la carga inicial
        setupLoginPage();

		// Ejecutar en navegaciones del lado del cliente
        document.addEventListener('astro:page-load', setupLoginPage);
	</script>
</Layout>
